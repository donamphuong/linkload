#!/usr/bin/ruby

#include the tuple class
load 'tuple.rb'

$ignore = (`git ls-files --others`).split('\n')
#a hash that maps a file to tuple that store a commit's information
$map = Hash.new
#the longest word in maps
$longest = 0

def traverse(start)
  Dir.foreach(start) do |x|
    path = File.join(start, x)

    if(x == '.' || x == '..')
      next
    elsif File.file?(path)
      if File.readable?(x)
        if (!$ignore.include? "#{x}\n")
  	       $longest = $longest < x.length ? x.length : $longest
           parse(x)
        elsif
          puts "[***not under version control***]: #{x}"
        end
      end
    else
      traverse(path)
    end
  end
end

def parse(file)
  info = Tuple.new
  info.changeDate(`git log -1 --pretty=format:%cI #{file}`)
  info.changeAuthor(`git log -1 --pretty=format:%an #{file}`)
  info.changeCommit(`git log -1 --pretty=format:%h #{file}`)
  $map.store(file, info)
end

#print hash
def print_hash
  $map.each do |key, value|
    if(!(key.nil? || value.nil?))
      puts "#{value.getDate} [#{value.getCommit}]: #{key}" +
            " " * ($longest - key.length + 1) +
            "(#{value.getAuthor})"
    end
  end
end

if(ARGV.length > 1)
  puts "There can only be one directory"
  exit 1
else
  target_path = Dir.pwd
  if !ARGV.empty?
    target_path = target_path + "/" + ARGV[0]
  end

  traverse(target_path)
  print_hash
end
